<?php// confirm the session...require_once 'commons/dbconnect.php';require_once 'commons/rpgfunctions.php';require_once 'commons/sessions.php';require_once 'commons/grammar.php';require_once 'commons/formatting.php';require_once 'commons/petlib.php';require_once 'commons/favorlib.php';$favor_cost = 250;$max_revives = floor($user['favor'] / $favor_cost);if($_POST['action'] == 'Give Broth' && $max_revives > 0){  $pets = array();  $this_pet = array();  foreach($_POST as $key=>$value)  {    if(substr($key, 0, 4) == 'pet_')    {      $i = substr($key, 4);      $pets[] = (int)$i;    }  }  foreach($pets as $petid)  {    $get_pet = get_pet_byid($petid);    $this_pet[] = $get_pet;    if($get_pet['dead'] != 'no' || $get_pet['zombie'] == 'yes')    {      $errored = true;      $error_message = 'One or more of the selected pets is dead!';      break;    }    else if($get_pet['user'] != $user['user'])    {      $errored = true;      $error_message = 'One or more of the selected pets does not belong to you.';      break;    }    else if($get_pet['free_respec'] == 'yes')    {      $errored = true;      $error_message = 'One or more of the selected pets is already eligible for retraining.';      break;    }  }  if(count($this_pet) > $max_revives)  {    $errored = true;    $error_message = 'You cannot afford to give this broth to more than ' . $max_revives . ' pets.';  }  if($errored == false)  {    $idnums = array();    foreach($this_pet as $pet)      $idnums[] = $pet['idnum'];    foreach($userpets as $localid=>$pet)    {      if(in_array($pet['idnum'], $idnums))        $userpets[$localid]['dead'] = "no";    }    $affected_pets = count($idnums);    $command = 'UPDATE monster_pets SET free_respec=\'yes\' WHERE idnum IN (' . implode(',', $idnums) . ') LIMIT ' . $affected_pets;    $database->FetchNone($command, 'marking pets for free respec');    $favor = 'pet respec';    if($affected_pets > 1)    {      $favor .= ' &times;' . $affected_pets;      $message = $affected_pets . ' pets may now be retrained.  You can perform the retraining by visiting the pets\' profile pages.';    }    else      $message = 'Your pet may now be retrained.  You can perform the retraining by <a href="/petprofile.php?petid=' . $idnums[0] . '">visiting the pet\'s profile page</a>.';    require_once 'commons/dailyreportlib.php';    record_daily_report_stat('Someone Paid to Respec a Pet', $affected_pets);    spend_favor($user, $favor_cost * count($idnums), $favor);  }}$command = 'SELECT * FROM monster_pets WHERE user=' . quote_smart($user['user']) . ' AND location=\'home\' AND dead=\'no\' AND zombie=\'no\' AND free_respec=\'no\'';$pets = $database->FetchMultiple($command, 'fetching available pets');include 'commons/html.php';?> <head>  <title>PsyPets &gt; The Temple &gt; Proselytism's Broth</title><?php include "commons/head.php"; ?> </head> <body><?php include 'commons/header_2.php'; ?>     <h4><a href="autofavor.php">The Temple</a> &gt; Proselytism's Broth</h4>     <ul class="tabbed">      <li><a href="temple.php">Donations</a></li>      <li><a href="temple_exchange.php">Exchanges</a></li>      <li><a href="af_revive2.php">Resurrections</a></li>      <li class="activetab"><a href="af_respec.php">Proselytism's Broth</a></li>     </ul><?phpecho '<img src="gfx/npcs/monk.png" align="right" width="350" height="535" alt="(Lance the Monk)" />';include 'commons/dialog_open.php';if($error_message)  echo '<p class="failure">' . $error_message . '</p>';else if($message)  echo '<p class="success">' . $message . '</p>';else{?><p>This Broth is created following directions in the Book of Ki Ri.  It enables the drinker to live life a second time, making new - hopefully better - choices.</p><p>If given to a pet, you will be able to completely retrain it, redistributing its skills, as well as its mental and physical attributes.</p><p>Each Broth costs <?= $favor_cost ?> Favor.</p><?php  if($max_revives < 1)    echo '<p>It looks like you don\'t have enough Favor, and unfortunately I can make no exceptions.  Please come back when you\'ve <a href="buyfavors.php">bought some Favor</a>.</p>';}$options[] = '<a href="/buyfavors.php">Support PsyPets; get Favor</a>';include 'commons/dialog_close.php';?>     <p>You currently have <?= $user['favor'] ?> Favor.  Each pet you wish to retrain will cost <?= $favor_cost ?>.</p><?phpif(count($options) > 0)  echo '<ul><li>' . implode('</li><li>', $options) . '</li></ul>';if($max_revives >= 1){  if(count($pets) > 0)  {?>     <form method="post">     <table>      <tr class="titlerow"><th></th><th></th><th>Name</th><th>Level</th></tr><?php    $rowclass = begin_row_class();    foreach($pets as $pet)    {      if($pet['free_respec'] == 'no' && $pet['dead'] == 'no')      {?>      <tr class="<?= $rowclass ?>">       <td><input type="checkbox" name="pet_<?= $pet['idnum'] ?>" /></td>       <td><img src="gfx/pets/<?= $pet['graphic'] ?>" /></td>       <td><?= $pet['petname'] ?></td>       <td class="centered"><?= pet_level($pet) ?></td>      </tr><?php        $rowclass = alt_row_class($rowclass);      }    }?>     </table>     <p><input type="submit" name="action" value="Give Broth" /></p>     </form><?php  }}?>     <hr />     <ul>      <li>This marks a pet for retraining; you may perform the retraining at any time in the future.</li>      <li>If a pet is not listed here, it is either dead, a zombie, or already eligible for retraining.</li>     </ul><?php include 'commons/footer_2.php'; ?> </body></html>